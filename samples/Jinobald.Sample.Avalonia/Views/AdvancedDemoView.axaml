<UserControl
    x:Class="Jinobald.Sample.Avalonia.Views.AdvancedDemoView"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:vm="using:Jinobald.Sample.Avalonia.ViewModels">

    <Design.DataContext>
        <vm:AdvancedDemoViewModel />
    </Design.DataContext>

    <ScrollViewer>
        <StackPanel Margin="16" Spacing="24">

            <!--  Header  -->
            <StackPanel>
                <TextBlock
                    FontSize="24"
                    FontWeight="Bold"
                    Text="Advanced Features Demo" />
                <TextBlock
                    Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                    Text="새로 추가된 고급 기능들을 시연합니다" />
            </StackPanel>

            <!--  1. Validation Demo (ValidatableViewModelBase)  -->
            <Border
                Padding="16"
                Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                CornerRadius="8">
                <StackPanel Spacing="12">
                    <TextBlock
                        FontSize="16"
                        FontWeight="SemiBold"
                        Text="1. Validation (INotifyDataErrorInfo)" />
                    <TextBlock
                        FontSize="12"
                        Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                        Text="ValidatableViewModelBase를 사용한 Data Annotations 검증" />

                    <Grid ColumnDefinitions="120,*,*" RowDefinitions="Auto,Auto,Auto,Auto">
                        <!--  Email  -->
                        <TextBlock
                            Grid.Row="0"
                            Grid.Column="0"
                            VerticalAlignment="Center"
                            Text="Email:" />
                        <TextBox
                            Grid.Row="0"
                            Grid.Column="1"
                            Margin="8,4"
                            Text="{Binding Email, Mode=TwoWay}" />
                        <TextBlock
                            Grid.Row="0"
                            Grid.Column="2"
                            VerticalAlignment="Center"
                            Foreground="Red"
                            IsVisible="{Binding HasErrors}"
                            Text="{Binding Errors[Email]}" />

                        <!--  Username  -->
                        <TextBlock
                            Grid.Row="1"
                            Grid.Column="0"
                            VerticalAlignment="Center"
                            Text="Username:" />
                        <TextBox
                            Grid.Row="1"
                            Grid.Column="1"
                            Margin="8,4"
                            Text="{Binding Username, Mode=TwoWay}" />
                        <TextBlock
                            Grid.Row="1"
                            Grid.Column="2"
                            VerticalAlignment="Center"
                            Foreground="Red"
                            Text="{Binding Errors[Username]}" />

                        <!--  Age  -->
                        <TextBlock
                            Grid.Row="2"
                            Grid.Column="0"
                            VerticalAlignment="Center"
                            Text="Age:" />
                        <NumericUpDown
                            Grid.Row="2"
                            Grid.Column="1"
                            Margin="8,4"
                            Maximum="200"
                            Minimum="0"
                            Value="{Binding Age, Mode=TwoWay}" />
                        <TextBlock
                            Grid.Row="2"
                            Grid.Column="2"
                            VerticalAlignment="Center"
                            Foreground="Red"
                            Text="{Binding Errors[Age]}" />

                        <!--  Buttons  -->
                        <StackPanel
                            Grid.Row="3"
                            Grid.Column="1"
                            Margin="8,12,8,0"
                            Orientation="Horizontal"
                            Spacing="8">
                            <Button Command="{Binding ValidateAllFieldsCommand}" Content="Validate All" />
                            <Button Command="{Binding ClearValidationCommand}" Content="Clear" />
                        </StackPanel>
                    </Grid>

                    <TextBlock FontSize="12" Foreground="Green">
                        <TextBlock.Text>
                            <MultiBinding StringFormat="HasErrors: {0}">
                                <Binding Path="HasErrors" />
                            </MultiBinding>
                        </TextBlock.Text>
                    </TextBlock>
                </StackPanel>
            </Border>

            <!--  2. CompositeCommand Demo  -->
            <Border
                Padding="16"
                Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                CornerRadius="8">
                <StackPanel Spacing="12">
                    <TextBlock
                        FontSize="16"
                        FontWeight="SemiBold"
                        Text="2. CompositeCommand" />
                    <TextBlock
                        FontSize="12"
                        Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                        Text="여러 명령을 하나로 조합하여 동시에 실행" />

                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Command="{Binding SaveProfileCommand}" Content="Save Profile" />
                        <Button Command="{Binding SaveSettingsCommand}" Content="Save Settings" />
                        <Button
                            Command="{Binding SaveAllCommand}"
                            Content="Save All (Composite)"
                            FontWeight="Bold" />
                    </StackPanel>

                    <TextBlock
                        FontSize="12"
                        FontWeight="SemiBold"
                        Text="실행 로그:" />
                    <Border
                        Padding="8"
                        Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                        CornerRadius="4">
                        <TextBlock
                            MinHeight="60"
                            FontFamily="Consolas"
                            FontSize="11"
                            Text="{Binding CompositeCommandLog}" />
                    </Border>
                </StackPanel>
            </Border>

            <!--  3. Event Filter Demo  -->
            <Border
                Padding="16"
                Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                CornerRadius="8">
                <StackPanel Spacing="12">
                    <TextBlock
                        FontSize="16"
                        FontWeight="SemiBold"
                        Text="3. Event Filter &amp; Weak Event" />
                    <TextBlock
                        FontSize="12"
                        Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                        Text="이벤트 필터링 (짝수만) 및 Weak Reference 구독" />

                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Command="{Binding PublishEventCommand}" Content="Publish Event" />
                        <Button Command="{Binding ClearEventLogCommand}" Content="Clear Log" />
                    </StackPanel>

                    <TextBlock
                        FontSize="12"
                        FontWeight="SemiBold"
                        Text="이벤트 로그 ([All]=모든 이벤트, [Even Only]=짝수만):" />
                    <Border
                        MaxHeight="120"
                        Padding="8"
                        Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                        CornerRadius="4">
                        <ScrollViewer>
                            <ItemsControl ItemsSource="{Binding EventLog}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock
                                            FontFamily="Consolas"
                                            FontSize="11"
                                            Text="{Binding}" />
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Border>
                </StackPanel>
            </Border>

            <!--  4. IConfirmNavigationRequest Demo  -->
            <Border
                Padding="16"
                Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                CornerRadius="8">
                <StackPanel Spacing="12">
                    <TextBlock
                        FontSize="16"
                        FontWeight="SemiBold"
                        Text="4. IConfirmNavigationRequest" />
                    <TextBlock
                        FontSize="12"
                        Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                        Text="페이지 이동 전 확인 다이얼로그 표시 (저장되지 않은 변경사항이 있을 때)" />

                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Command="{Binding MarkAsChangedCommand}" Content="Mark as Changed" />
                        <Button Command="{Binding SaveChangesCommand}" Content="Save Changes" />
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock VerticalAlignment="Center" Text="HasUnsavedChanges:" />
                        <TextBlock
                            VerticalAlignment="Center"
                            FontWeight="Bold"
                            Text="{Binding HasUnsavedChanges}" />
                        <TextBlock Foreground="Orange" IsVisible="{Binding HasUnsavedChanges}">
                            (다른 페이지로 이동 시 확인 다이얼로그가 표시됩니다)
                        </TextBlock>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!--  5. Generic IDialogResult<T> Demo  -->
            <Border
                Padding="16"
                Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                CornerRadius="8">
                <StackPanel Spacing="12">
                    <TextBlock
                        FontSize="16"
                        FontWeight="SemiBold"
                        Text="5. Generic IDialogResult&lt;T&gt;" />
                    <TextBlock
                        FontSize="12"
                        Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                        Text="강타입 데이터를 반환하는 다이얼로그" />

                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Command="{Binding ShowTypedDialogCommand}" Content="Select User (Typed Dialog)" />
                    </StackPanel>

                    <TextBlock FontWeight="SemiBold" Text="{Binding SelectedUserInfo}" />
                </StackPanel>
            </Border>

            <!--  6. IRegionMemberLifetime Demo  -->
            <Border
                Padding="16"
                Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                CornerRadius="8">
                <StackPanel Spacing="12">
                    <TextBlock
                        FontSize="16"
                        FontWeight="SemiBold"
                        Text="6. IRegionMemberLifetime" />
                    <TextBlock
                        FontSize="12"
                        Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                        Text="Region에서 View의 수명 제어 (KeepAlive)" />

                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <CheckBox Content="KeepAlive 활성화" IsChecked="{Binding KeepAliveEnabled}" />
                    </StackPanel>

                    <TextBlock FontSize="12" TextWrapping="Wrap">
                        KeepAlive=true: 다른 페이지 갔다가 돌아와도 상태 유지
                        KeepAlive=false: 매번 새로 생성됨
                    </TextBlock>
                </StackPanel>
            </Border>

            <!--  7. IDisposable (ViewModelBase) Info  -->
            <Border
                Padding="16"
                Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                CornerRadius="8">
                <StackPanel Spacing="8">
                    <TextBlock
                        FontSize="16"
                        FontWeight="SemiBold"
                        Text="7. IDisposable (ViewModelBase)" />
                    <TextBlock
                        FontSize="12"
                        Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                        TextWrapping="Wrap">
                        ViewModelBase에 DisposableCollection이 내장되어 있어
                        이벤트 구독, 타이머 등의 리소스를 자동 정리합니다.
                        이 ViewModel은 Dispose 시 이벤트 구독을 해제합니다.
                    </TextBlock>

                    <Border
                        Margin="0,8,0,0"
                        Padding="12"
                        Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                        CornerRadius="4">
                        <TextBlock
                            FontFamily="Consolas"
                            FontSize="11"
                            TextWrapping="Wrap">
                            protected override void Dispose(bool disposing)
                            {
                                if (disposing)
                                {
                                    _eventAggregator.Unsubscribe(_allEventsToken);
                                    _eventAggregator.Unsubscribe(_filteredEventsToken);
                                    SaveAllCommand.UnregisterCommand(SaveProfileCommand);
                                    SaveAllCommand.UnregisterCommand(SaveSettingsCommand);
                                }
                                base.Dispose(disposing);
                            }
                        </TextBlock>
                    </Border>
                </StackPanel>
            </Border>

        </StackPanel>
    </ScrollViewer>
</UserControl>
